<!doctype html>
<html>
  <head>
    <title>Websocket example</title>
  <script>
  function rotate(start){
    console.log(start);
    return (start);
  }
  </script>
  <style>
    .grid {
      display: grid;
      grid: repeat({{ height }}, 12vw) / auto-flow;
    }
    
    .row {
      display: grid;
      grid: repeat(1, 12vw) / auto-flow;
    }
    
    .row > .cell {
      margin: 10px;
      background: rgb(252, 245, 244);
    }

    .brush {
      display: table-cell;
    }
    
    @media (orientation: portrait) {
      
      .container {
        transform: rotate(90deg) translate(35%);
      }
        
      .row > .square {
        transform: rotate(-90deg);
      }
    }
  </style>
  </head>
  <body>
    <input type="text" id="message">
    <button>Send</button>
    <ul></ul>
    <script type="text/javascript">
      const reader = new FileReader();
      reader.addEventListener('loadend', (e) => {
        const text = e.srcElement.result;
        console.log(text);
      });
      var ws = new WebSocket('ws://' + document.domain + ':' + location.port + '/ws');
      //var ws = new WebSocket('ws://' + document.domain + ':' + location.port + '/api/v2/ws');
      ws.onmessage = function (event) {
        console.log("Incoming ws: " + event.data);
        var incoming = JSON.parse(event.data);
        if (incoming.Type == "Chat"){ // handle chat messages
          var messages_dom = document.getElementsByTagName('ul')[0];
          var message_dom = document.createElement('li');
          var content_dom = document.createTextNode('Received: ' + incoming.Data);
          message_dom.appendChild(content_dom);
          messages_dom.appendChild(message_dom);
        }
        if (incoming.Type == "Pixel"){ // handle incoming pixel changes
          var cells = document.getElementsByClassName("cell");
          // console.log("Trying to change a pixel; incoming.Data looks like " + incoming.Data);
          // Data looks like "[1, 2, red]"
          var targetx = incoming.Data.split(', ')[0].slice(1); // targetx comes before comma and after bracket
          var targety = incoming.Data.split(', ')[1]; // targety is between commas
          var targetcolor = incoming.Data.split(', ')[2].slice(0,incoming.Data.split(', ')[2].length - 1) // color is at the end, minus bracket
          for (i = 0; i < cells.length; i++) {
            // console.log("i is " + i + ", and incoming.Data[0] is " + incoming.Data[0] + " and cells[i].dataset.x is " + cells[i].dataset.x)
            if (targetx == cells[i].dataset.x && targety == cells[i].dataset.y) {
              cells[i].style.backgroundColor = targetcolor;
            }
          }
        }
        if (incoming.Type == "System") { //handles system messages
          console.log("Received system message: " + incoming.Data);
        }
      };

      var button = document.getElementsByTagName('button')[0];
      button.onclick = function() {
        var content = document.getElementsByTagName('input')[0].value;
        ws.send('{"Type":"Chat","Data":"' + content + '"}');
      };
      function clickCell(cell) { // change a cell's color when clicked
        brushes = document.getElementsByClassName("brush"); // collect brushes
        color = "black";
        for (var i = 0; i < brushes.length; i++) {
          if (brushes[i].dataset.active == "True") { // find which is active
            color = brushes[i].style.backgroundColor; // set color to that brush
            // console.log("Color identified as " + color);
          }
        }
        cell.style.backgroundColor = color; // change cell color on page
        console.log("Cell " + cell.dataset.x + ", " + cell.dataset.y + " is now " + color); // log change to console
        ws.send('{"Type":"Pixel","Data":"[' + cell.dataset.x + ', ' + cell.dataset.y + ', ' + cell.style.backgroundColor + ']"}') // ws message back to server to change cell in device
        return;
      }
      function brushClick(brush) { // change the brush color when clicked
        brushes = document.getElementsByClassName("brush");
        for (var i = 0; i < brushes.length; i++) {
          // console.log("Current brushes["+i+"].dataset.active == " + brushes[i].dataset.active);
          brushes[i].dataset.active = "False";
        }
        brush.dataset.active = "True";
        console.log("The " + brush.style.backgroundColor + " brush is now active")
      }
    </script>
    <div style="display: table;">
      <div style="display: table-row; height: 60px;">
        <div class="brush" name="brush" data-active="True"  id="redbrush" style="background-color:red;" onclick="brushClick(this)">Red</div>
        <div class="brush" name="brush" data-active="False" id="greenbrush" style="background-color:green;" onclick="brushClick(this)">Green</div>
        <div class="brush" name="brush" data-active="False" id="bluebrush" style="background-color:blue;" onclick="brushClick(this)">Blue</div>
      </div>
    </div>
    <div class="grid">
      {% for y in ys %}
        <div class="row">
          {% for x in xs %}
          <div class="cell" onclick="clickCell(this)" data-x="{{ x }}" data-y="{{ y }}">{{ x }},{{ y }}</div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </body>
</html>
